@component-name = "portal-security"
definition {

	property custom.properties = "mail.send.blacklist=noreply@liferay.com,noreply@domain.invalid,test@domain.invalid";
	property dummy.socket.proxy.disabled = "true";
	property osgi.app.includes = "multi-factor-authentication";
	property portal.release = "true";
	property portal.upstream = "true";
	property test.run.environment = "EE";
	property test.smtp.server.enabled = "true";
	property testray.main.component.name = "Multi Factor Authentication";

	setUp {
		TestCase.setUpPortalInstance();

		User.firstLoginPG();
	}

	tearDown {
		var testPortalInstance = PropsUtil.get("test.portal.instance");

		if ("${testPortalInstance}" == "true") {
			PortalInstances.tearDownCP();
		}
		else {
			User.logoutAndLoginPG(
				userLoginEmailAddress = "test@liferay.com",
				userLoginFullName = "Test Test");

			JSONUser.tearDownNonAdminUsers();
		}
	}

	@description = "This is a use case for LPS-101720"
	@priority = "5"
	test LoginWithOTPEnabled {
		property database.types = "db2,hypersonic,mariadb,mysql,oracle,postgresql,sqlserver,sybase";

		var portalURL = PropsUtil.get("portal.url");

		JSONUser.addUser(
			userEmailAddress = "userea@liferay.com",
			userFirstName = "userfn",
			userLastName = "userln",
			userScreenName = "usersn");

		User.openUsersAdmin();

		User.editPasswordCP(
			userEmailAddress = "userea@liferay.com",
			userScreenName = "usersn");

		PortalSettings.gotoConfiguration(
			configurationCategory = "Multi-Factor Authentication",
			configurationName = "Email One-Time Password Configuration",
			configurationScope = "Virtual Instance Scope");

		MultiFactorAuthentication.configureOTPEmailSender(
			emailAddress = "test@liferay.com",
			emailSenderName = "Joe Bloggs");

		MultiFactorAuthentication.viewOTPEmailSenderCP(
			emailAddress = "test@liferay.com",
			emailSenderName = "Joe Bloggs");

		MultiFactorAuthentication.configureOTP(enableOTP = "true");

		SignOut.signOut();

		SignIn.signIn(userEmailAddress = "userea@liferay.com");

		MultiFactorAuthentication.sendOTPEmailPG();

		MultiFactorAuthentication.verifyOTP(
			portalURL = "${portalURL}",
			recipient = "userfn userln",
			userEmailAddress = "userea@liferay.com",
			userPassword = "test");
	}

}